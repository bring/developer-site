{{- $schemas := .schemas -}}
{{- $schemaPath := path.Split .ctx -}}
{{- $schemaRef := $schemaPath.File -}}
{{- $endpointId := .endpointId -}}
{{- $nested := .nested -}}
{{- $required := slice -}}
{{- $requiredParam := "" -}}

{{- range $schemas -}}
    {{- $responseSchema := index . $schemaRef -}}

    {{- range $key, $value := $responseSchema -}}
      {{- if eq $key "required" -}}
        {{- $required = $value -}}
      {{- end -}}
    {{- end -}}

    {{- range $key, $value := $responseSchema -}}
      {{- if reflect.IsMap . -}}
        {{- $isParent := false -}}
        {{- range $param, $_ := . -}}
          
          {{- range $required -}}
            {{- if eq . $param -}}
              {{- $requiredParam = . -}}
            {{- end -}}
          {{- end -}}

          {{- $typeArrObj := false -}}
          {{- if reflect.IsMap . -}}
            {{- range $k, $v := . -}}
              {{- if or (eq $v "array") (eq $k "$ref") -}}
                {{- $typeArrObj = true -}}
              {{- end -}}
            {{- end -}}
          {{- end -}}

          {{- if and (eq $nested true) (reflect.IsMap .) -}}
            <div>
              <dl class="desc-list flex mb-border bb bw1 mbs pbs">
                <dt class="pls">
                  <code>{{- $param -}}</code>
                  {{if eq $param $requiredParam}}{{- partial "api/required.html" -}}{{- end -}}
                </dt>
                <dd>
                  {{- partial "api/schema-dd" ( dict "ctx" . "isParent" $isParent ) -}}
                </dd>

          {{- else if $typeArrObj -}}
            {{ $isParent = true }}
            <dl class="desc-list mb-border bb bw1 mbs pbs">
              <div class="flex align-ifs">
                <dt id='{{$endpointId}}-{{$param}}' class="param-toggle-btn">
                  <button class="btn-link">
                    <span
                      data-mybicon="mybicon-arrow-right"
                      data-mybicon-class="icon-ui param-toggle-icon"
                      data-mybicon-width="16"
                      data-mybicon-height="16">
                    </span>
                    <code>{{- $param -}}</code>
                  </button>
                  {{- if eq $param $requiredParam -}}
                    <div class="plm mls">
                    {{ partial "api/required.html" }}
                    </div>
                  {{- end -}}
                </dt>
                <dd>
                  {{- partial "api/schema-dd" ( dict "ctx" . "isParent" $isParent ) -}}
                </dd>
              </div>

          {{- else -}}
            {{ $isParent = false }}
            {{if reflect.IsMap $_ -}}
            <dl class="desc-list flex mb-border bb bw1 mbs pbs">
              <dt class="plm mlxs">
                <code>{{- $param -}}</code>
                {{if eq $param $requiredParam}}{{- partial "api/required.html" -}}{{- end -}}
              </dt>
              <dd>
                {{- partial "api/schema-dd" ( dict "ctx" . "isParent" $isParent ) -}}
              </dd>
            {{- end -}}
          {{- end -}}

        {{- if $isParent -}}
          <dd data-sublevel-id='{{$endpointId}}-{{$param}}' class="pls mls mb-border bl bw1 dn">
            {{- if eq $nested false -}}
              <dl class="desc-list mbm pts">
            {{- end -}}
            {{- if reflect.IsMap . -}}
              {{- range $i, $_ := . -}}
                {{- if reflect.IsMap . -}}
                  {{- range $j, $_ := . -}}
                    {{- if eq $j "$ref" -}}
                      {{- partial "api/schema.html" (dict "ctx" . "schemas" $schemas "nested" true) -}}
                    {{- end -}}
                  {{- end -}}
                {{- else -}}
                  {{- if eq $i "$ref" -}}
                    {{- partial "api/schema.html" (dict "ctx" . "schemas" $schemas "nested" true) -}}
                  {{- end -}}
                {{- end -}}
              {{- end -}}
            {{- end -}}
            {{- if eq $nested false -}}
              </dl>
            {{- end -}}
          </dd>
        {{- end -}}

          {{- if and (eq $nested true) (reflect.IsMap $_) -}}
            </div>
          {{- else -}}
            </dl>
          {{- end -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
{{- end -}}
