{{- $schemas := .schemas -}}
{{- $schemaPath := path.Split .ctx -}}
{{- $schemaRef := $schemaPath.File -}}
{{- $endpointId := .endpointId -}}
{{- $nested := .nested -}}
{{- $displayClass := "" -}}
{{- $required := slice -}}
{{- $requiredParam := "" -}}

{{- range $schemas -}}
    {{- $responseSchema := index . $schemaRef -}}

    {{- range $key, $value := $responseSchema -}}
      {{if eq $key "required" -}}
        {{- $required = $value -}}
      {{- end -}}
    {{- end -}}

    {{- range $key, $value := $responseSchema -}}
      {{- if reflect.IsMap . -}}
        {{- range $param, $_ := . -}}
          
          {{- range $required -}}
            {{- if eq . $param -}}
              {{- $requiredParam = . -}}
            {{- end -}}
          {{- end -}}

          {{- $type := "" -}}

          {{- if reflect.IsMap $_ -}}
            {{- range $k, $v := . -}}
              {{- if eq $v "array" -}}
                {{- $type = $v -}}
                {{- $displayClass = "dn pls mls mb-border bl bw1" -}}
              {{- else if eq $k "$ref" -}}
                {{- $type = "object" -}}
                {{- $displayClass = "dn pls mls mb-border bl bw1" -}}
              {{- end -}}
            {{- end -}}
          {{- end -}}

          {{- if and (eq $nested true) (reflect.IsMap $_) -}}
          <div>
            <dl class="desc-list flex mb-border bb bw1 mbs pbs">
              <dt class="pls">
                <code>{{- $param -}}</code>
                {{if eq $param $requiredParam}}{{- partial "api/required.html" -}}{{- end -}}
              </dt>
          {{- else if or (eq $type "array") (eq $type "object") -}}
            <dl class="desc-list mb-border bb bw1 mbs pbs">
              <div class="flex align-ifs">
                <dt id='{{$endpointId}}-{{$param}}' class="param-toggle-btn">
                  <button class="btn-link">
                    <span
                      data-mybicon="mybicon-arrow-right"
                      data-mybicon-class="icon-ui param-toggle-icon"
                      data-mybicon-width="16"
                      data-mybicon-height="16">
                    </span>
                    <code>{{- $param -}}</code>
                  </button>
                  {{- if eq $param $requiredParam -}}
                    <div class="plm mls">
                    {{ partial "api/required.html" }}
                    </div>
                  {{- end -}}
                </dt>
                <dd>
                  {{ .description }}
                  <div class="gray text-note">{{ $type }}</div>
                </dd>
              </div>
          {{- else -}}
            {{if reflect.IsMap $_ -}}
            <dl class="desc-list flex mb-border bb bw1 mbs pbs">
              <dt class="plm mlxs">
                <code>{{- $param -}}</code>
                {{if eq $param $requiredParam}}{{- partial "api/required.html" -}}{{- end -}}
              </dt>
            {{- end -}}
          {{- end -}}

          <dd data-sublevel-id='{{$endpointId}}-{{$param}}' class="{{$displayClass}}">
            {{- if eq $nested false -}}
              <dl class="desc-list mbm pts">
            {{- end -}}
            {{- if reflect.IsMap . -}}
              {{- range $i, $_ := . -}}
                {{- if reflect.IsMap . -}}
                  {{- range $j, $_ := . -}}
                    {{- if eq $j "$ref" -}}
                      {{- partial "api/schema.html" (dict "ctx" . "schemas" $schemas "nested" true) -}}
                    {{- end -}}
                  {{- end -}}
                {{- else if reflect.IsSlice . -}}
                  Enum:
                  <div>
                    {{- range . -}}
                      <code>{{- . -}}</code><br>
                    {{- end -}}
                  </div>
                {{- else -}}
                  {{- if eq $i "$ref" -}}
                    {{- partial "api/schema.html" (dict "ctx" . "schemas" $schemas "nested" true) -}}
                  {{- else if eq . "int32" "integer" "string" "boolean" -}}
                    <div class="text-note gray">{{- . -}}</div>
                  {{- else if and (eq $i "description") (eq $nested true) -}}
                    <div>{{- . -}}</div>
                  {{- end -}}
                {{- end -}}
              {{- end -}}
            {{- end -}}
            {{- if eq $nested false -}}
              </dl>
            {{- end -}}
          </dd>
          {{- if and (eq $nested true) (reflect.IsMap $_) -}}
            </div>
          {{- else -}}
            </dl>
          {{- end -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
{{- end -}}
