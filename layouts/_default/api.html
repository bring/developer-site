{{- define "main" -}}
  {{- $notAnApi := $.Param "notanapi" -}}
  {{- $maxwidth := "maxw80r" -}}
  {{- if (eq ($.Param "widelayout") true) -}}
    {{- $maxwidth = "maxw108r" -}}
  {{- end -}}

  <div class="dev-docs__menu" data-drawer data-drawer-event>
    {{- partial "sidemenu.html" . -}}
  </div>
  {{- partial "drawmenu.html" . -}}
  <div class="dev-docs__page">
    {{- if (eq $notAnApi true) -}}
      <main id="main" class="dev-docscontent w100p {{ $maxwidth }}">
        <article>
          <h1>
            {{- .Title -}}
            {{- with .Params.titlesub -}}
              <span class="db text-title mts">{{ . }}</span>
            {{- end -}}
          </h1>
          {{- if or (isset .Params "services") (isset .Params "examples") -}}
            {{- partial "api/guide.html" . -}}
          {{- end -}}
          {{- if and (isset .Params "apidoc") (isset .Params "apiresources") -}}
            {{- partial "api/guideapi.html" . -}}
          {{- end -}}
          {{- if and (isset .Params "apidoc") (isset .Params "apiresource") -}}
            {{- partial "api/guideapiresource.html" . -}}
          {{- end -}}
          {{- .Content -}}
          {{- if (in .CurrentSection "revision-history") -}}
            {{- partial "api/changelog.html" . -}}
          {{- end -}}
          {{- if and (eq (getenv "HUGO_ENV") "production") (isset $.Params "disqus_identifier") -}}
            <section class="dev-docscontent__section">
              {{ template "_internal/disqus.html" $ }}
            </section>
          {{ end }}
          </article>
        </main>
      {{- else if and (isset $.Params "oas") (or (eq (getenv "HUGO_ENV") "dev") (eq .Title "Address API" )) -}}
        <main id="main" class="dev-docscontent w100p {{ replace .Title "API" "" | urlize }}">
          <article>
            <h1>{{ .Title }}</h1>
            <section id="api-documentation" class="dev-docscontent__section dev-docscontent__wrap">
              {{- with $.Params.important -}}
                <div class="dev-docscontent__side">
                  {{- range . -}}
                    <div class="message--{{ .type }} pal mbs">
                      {{- with .title -}}
                        <strong class="db mbxs">{{ . }}</strong>
                      {{- end -}}
                      {{ .message | markdownify }}
                    </div>
                  {{- end -}}
                </div>
              {{- end -}}
              <div class="dev-docscontent__main maxw64r">
                {{- with $.Params.introduction -}}
                  {{- if in (string .) "\n\n" -}}
                  <div class="text-heading fw600">
                    {{- . | markdownify -}}
                  </div>
                  {{- else -}}
                    <p class="text-heading fw600 mbl">{{ . | markdownify }}</p>
                  {{- end -}}
                {{- end -}}
                {{- with $.Params.information -}}
                  <div class="dev-docscontent__info mvl">
                    {{- range . -}}
                      <details class="bg-green1 rad-a2px mbxs">
                        {{- with .title }}
                          <summary class="pas plm">
                            {{- . -}}
                          </summary>
                        {{- end -}}
                        {{- if in (string .content) "\n\n" -}}
                          {{- .content | markdownify -}}
                        {{- else -}}
                          <p>{{ .content | markdownify }}</p>
                        {{- end -}}
                      </details>
                    {{- end -}}
                  </div>
                {{- end -}}
                {{- range $.Params.documentation -}}
                  {{- with .title }}
                    <h2 class="dev-anchored" id="{{ . | urlize }}">
                      {{- . -}}
                    </h2>
                  {{- end -}}
                  {{- if in (string .content) "\n\n" -}}
                    {{- .content | markdownify -}}
                  {{- else -}}
                    <p>{{ .content | markdownify }}</p>
                  {{- end -}}
                {{- end -}}
              </div>
            </section>
            <section class="dev-docscontent__section maxw96r">
              {{ $oasData := getJSON $.Params.oas }}
              {{ with $oasData }}
                {{ $components := .components }}
                {{ range $path, $_ := .paths }}
                  {{ range $type, $_ := . }}
                    {{ $endpointId := .summary | anchorize }}
                    <div id="{{ $endpointId }}" class="flex flex-wrap mbxl ptm mb-border bb">
                      <div class="flex-1 flex-basis-20">
                        <span class="gray text-note">ID: {{$endpointId}}</span>
                        <h2>{{ .summary }}</h2>
                        <p><span class="mb-badge mb-badge--green ttu mrs pas">{{ $type }}</span> {{ $path }}</p>
                        <p class="text-heading">{{ .description }}</p>

                      {{- partial "api/params.html" (dict "parameters" .parameters) -}}

                        <p class="text-title">Responses</p>

                        {{ $responseCodeColor := "" }}
                        {{ $successCodes := "200 204" }}
                        {{ $errorCodes := "400 404 429 500" }}
                        {{ range $response, $_ := .responses }}
                          {{ if in $successCodes $response }}
                            {{ $responseCodeColor = "response success-code bg-green1" }}
                          {{ else if in $errorCodes $response }}
                            {{ $responseCodeColor = "response error-code" }}
                          {{ else }}
                            {{ $responseCodeColor = "response default" }}
                          {{ end }}

                          <details class="mbs">
                            <summary class="{{$responseCodeColor}} pas">{{ $response }} {{ .description }}</summary>
                          
                            <div class="bg-gray1 pam">
                              <label class="form__label text-basic dib" for="{{$endpointId}}">Response schema:</label>
                              <select id="{{$endpointId}}" class="form__control wauto maxw100p paxs dib schema-type-select">
                                {{ $selected := "selected" }}
                                {{ range $applicationType, $_ := .content }}
                                  <option value='schemaType-{{$response}}-{{$endpointId}}-{{$applicationType}}' {{$selected | safeHTMLAttr}}>
                                    {{ $applicationType }}
                                  </option>
                                  {{$selected = ""}}
                                {{ end }}
                              </select>

                              {{ range $application, $_ := .content }}
                                <div class="schema-type-container pam mb-border ba bg-white dn" data-schematype-id='schemaType-{{$response}}-{{$endpointId}}-{{$application}}'>
                                {{/*  Finding the schemarefs and using those in the partial to recursively output the schema data  */}}
                                {{ range $key, $_ := .schema }}
                                  {{ if reflect.IsMap . }}
                                    {{ range . }}
                                      {{- partial "api/schema.html" (dict "ctx" . "schemas" $components "nested" false "endpointId" $endpointId) -}}
                                    {{ end }}
                                  {{ else if eq $key "$ref" }}
                                      {{- partial "api/schema.html" (dict "ctx" . "schemas" $components "nested" false "endpointId" $endpointId) -}}
                                  {{ end }}
                                {{ end }}
                                </div>
                              {{ end }}
                          </details>
                        {{ end }}
                      </div>
                      <div class="flex-1 pas">
                        {{- partial "api/responseexample.html" (dict "components" $components "responses" .responses "endpointId" $endpointId) -}}
                      </div>
                    </div>
                    {{ end }}
                {{ end }}
              {{ end }}
            </section>
          </article>
        </main>
        <script type="text/javascript">
          const schemaTypeSelect = document.querySelectorAll('.schema-type-select');
          schemaTypeSelect.forEach(changeType);

          function changeType(type) {
            type.addEventListener('change', function() {
              const selectedOption = this.value
              const schemaTypeParent = document.querySelector('[data-schematype-id="'+selectedOption+'"]').parentNode
              const schemaTypes = schemaTypeParent.querySelectorAll('.schema-type-container')

              schemaTypes.forEach(schema => {
                schema.classList.add('dn')
              })
              
              showSelectedSchemaOption(this)
            })
          }

          function showSelectedSchemaOption(sel) {
            let opt;
            for ( let i = 0; i < sel.options.length; i++ ) {
              opt = sel.options[i];
              if ( opt.selected === true ) {
                  const schemaType = opt.value
                  const schemaTypeContainer = document.querySelector('[data-schematype-id="'+schemaType+'"]')
                  schemaTypeContainer.classList.remove('dn')
                  return schemaType
              }
            }
          }

          function showInitialSchemaType() {
            schemaTypeSelect.forEach(showSelectedSchemaOption);
          }

          showInitialSchemaType();
        </script>
        <script>
          function switchExample(containerArr, id) {
            containerArr.forEach(container => {
              if (container.dataset.responseEx === id) {
                container.hidden = false
              } else {
                container.hidden = true
              }
            })
          }

          const responseExBtns = document.querySelectorAll("input[data-response-ex]")
          responseExBtns.forEach(btn => {
            btn.addEventListener("click", function (e) {
              const element = e.target
              const resIdBtn = element.dataset.responseEx
              const resId = element.name
              const responseSection = document.querySelector('#' + resId)
              const exampleContainers = responseSection.querySelectorAll("div[data-response-ex]")

              switchExample(exampleContainers, resIdBtn)
            })
          })

          const responseExSelects = document.querySelectorAll("select[data-response-subex]")
          responseExSelects.forEach(select => {
            select.addEventListener("change", function (e) {
              const element = e.target
              const exId = element.value
              const responseSection = element.parentNode
              const exampleSubContainers = responseSection.querySelectorAll("div[data-response-subex]")

              switchExample(exampleSubContainers, exId)
            })
          })
        </script>
        <script type="text/javascript">
          const paramToggleBtn = document.querySelectorAll('.param-toggle-btn')

          paramToggleBtn.forEach(btn => {
            btn.addEventListener('click', function() {
              const paramToggleBtnId = this.id
              const paramSubLevel = document.querySelector('[data-sublevel-id="'+paramToggleBtnId+'"]')
              const paramToggleIcon = this.querySelector('.param-toggle-icon')
              paramSubLevel.classList.toggle('dn')
              paramToggleIcon.classList.toggle('rotate-icon-90')
            })
          })
        </script>
      {{- else -}}
      {{- partial "api/docs.html" . -}}
    {{- end -}}
    {{ partial "footer.html" . }}
    <div class="dev-obfuscator" data-drawer data-drawer-event></div>
  </div>
{{- end -}}
