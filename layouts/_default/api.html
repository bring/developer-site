{{- define "main" -}}
  {{- $notAnApi := $.Param "notanapi" -}}
  {{- $maxwidth := "maxw80r" -}}
  {{- if (eq ($.Param "widelayout") true) -}}
    {{- $maxwidth = "maxw108r" -}}
  {{- end -}}

  {{- if (eq $notAnApi true) -}}
    <main id="main" class="dev-docscontent w100p {{ $maxwidth }}">
      {{- with $.Parent.Params.subpages -}}
        <div class="dev-docscontent__backnav">
          <a href="{{ $.Parent.RelPermalink }}">&larr; Back to {{ $.Parent.Title }}</a>
        </div>
      {{- end -}}
      <article>
        <h1>
          {{- .Title -}}
          {{- with .Params.titlesub -}}
            <span class="db text-title mts">{{ . }}</span>
          {{- end -}}
        </h1>
        {{- if or (isset .Params "services") (isset .Params "examples") -}}
          {{- partial "api/guide.html" . -}}
        {{- end -}}
        {{- if and (isset .Params "apidoc") (isset .Params "apiresources") -}}
          {{- partial "api/guideapi.html" . -}}
        {{- end -}}
        {{- if and (isset .Params "apidoc") (isset .Params "apiresource") -}}
          {{- partial "api/guideapiresource.html" . -}}
        {{- end -}}

        {{ with .Content }}
          {{- if in (string .) "dev-docscontent__section" -}}
            {{- . -}}
          {{- else -}}
            <section class="dev-docscontent__section">
              {{- . -}}
            </section>
          {{- end -}}
        {{ end }}

        {{- if (in .CurrentSection "revision-history") -}}
          {{- partial "api/changelog.html" . -}}
        {{- end -}}
        {{- if and (eq (getenv "HUGO_ENV") "production") (isset $.Params "disqus_identifier") -}}
          <section class="dev-docscontent__section">
            {{ template "_internal/disqus.html" $ }}
          </section>
        {{- end -}}
      </article>
      {{- with $.Parent.Params.subpages -}}
        <div class="dev-docscontent__backnav">
          <a href="{{ $.Parent.RelPermalink }}">&larr; Back to {{ $.Parent.Title }}</a>
        </div>
      {{- end -}}
    </main>

  {{- else if in .Title "Order Management" -}}
    {{- partial "api/oas/restsoap.html" . -}}
  {{- else if isset $.Params "oas" -}}
    <main id="main" class="dev-docscontent w100p {{ replace .Title "API" "" | urlize }}">
      <article>
        {{- partial "api/oas/section-intro.html" . -}}

        {{- $oasData := getJSON $.Params.oas -}}
        {{- partial "api/oas/endpoints.html" (dict "oas" $oasData) -}}

        <section class="dev-docscontent__section oas-endpoints maxw96r">
          {{- with $oasData -}}
            {{ $baseUrl := "" }}
            {{- range .servers -}}
              {{- $baseUrl = replace .url "qa." "" -}}
              {{- $last := substr $baseUrl -1 -}}
              {{- if eq $last "/" -}}
                {{- $baseUrl = substr $baseUrl 0 -1 -}}
              {{- end -}}
            {{- end -}}
            {{- $components := .components -}}
            {{- range $path, $_ := .paths -}}
              {{- range $type, $_ := . -}}
                {{- $endpointId := (print .summary "-" $type | anchorize ) -}}
                <h2 class="dev-anchored" id="{{ $endpointId }}">{{ .summary }}</h2>
                <div class="flex flex-wrap mbxl pbxl mb-border bb gal">
                  <div class="param-response-area">
                    <div class="flex align-ifs mbl mts">
                      {{- partial "api/oas/endpoint-type" (dict "type" $type) -}}
                      <span class="flex-auto">
                        <pre class="flex align-ic pas mb0 wrap-text">
                          <span>{{ $baseUrl }}{{ $path }}</span>
                        </pre>
                      </span>
                    </div>
                    <p class="mbl text-heading">{{ .description | safeHTML }}</p>

                    {{- with or .parameters .requestBody -}}
                      <h3 class="mbm">Request</h3>
                    {{- end -}}

                    {{- with .parameters -}}
                      {{- partial "api/oas/request-params.html" (dict "parameters" .) -}}
                    {{- end -}}

                    {{- with .requestBody -}}
                      {{- $hasSchema := partial "api/oas/has-schema.html" . -}}

                      {{- if $hasSchema -}}
                        {{- with .content -}}
                          {{- $multiSchema := false -}}
                          {{- if gt (len .) 1 -}}
                            {{- $multiSchema = true -}}
                          {{- end -}}
                          <div class="mb-border bb flex flex-wrap mbm pbxs align-ib gcm">
                            <h4 class="fw600 mb0">Body schema</h4>
                            {{- if $multiSchema -}}
                            <div class="flex flex-wrap align-ib gcxs">
                              <label class="form__label text-basic" for="{{ $endpointId }}-reqschema">Media type:</label>
                              <select id="{{ $endpointId }}-reqschema" data-sub-of="{{ $endpointId }}-reqschema" class="form__control wauto maxw100p paxs hauto mb0" name="formats">
                                {{- range $applicationType, $_ := . -}}
                                  {{- $typeClean := lower (anchorize $applicationType) -}}
                                  <option value="{{ $typeClean }}">
                                    {{ $applicationType }}
                                  </option>
                                {{- end -}}
                              </select>
                            </div>
                            {{- else -}}
                              {{- range $applicationType, $_ := . -}}
                                <p class="mb0 text-note">Media type: {{ $applicationType }}</p>
                              {{- end -}}
                            {{- end -}}
                          </div>

                          {{- range $application, $_ := . -}}
                            {{- $fTC := partial "api/oas/format-type-clean.html" (dict "application" $application) -}}
                            {{- $format := $fTC.format -}}
                            {{- $typeClean := $fTC.typeClean -}}

                            <dl class="schema-type-container desc-list mbl" data-type="{{ $typeClean }}">
                              {{- if eq "xml" $format -}}
                                {{- partial "api/oas/request-schema-xml.html" (dict "schemaObj" .schema "name" "" "components" $components "endpointId" $endpointId "recLevel" 0) -}}
                              {{- else -}}
                                {{- partial "api/oas/request-schema.html" (dict "schemaObj" .schema "name" "" "components" $components "endpointId" $endpointId "recLevel" 0) -}}
                              {{- end -}}
                            </dl>
                          {{- end -}}
                        {{- end -}}
                      {{- end -}}
                    {{- end -}}

                    {{- with .responses -}}
                      <h3 class="mbm">Responses</h3>
                      {{- range $response, $_ := . -}}
                        {{- $responseColorBg := "bg-gray1" -}}
                        {{- $responseColorTxt := "" -}}
                        {{- if and (ge $response 200) (lt $response 300) -}}
                          {{- $responseColorBg = "bg-green1" -}}
                          {{- $responseColorTxt = "green-dark" -}}
                        {{- else if ge $response 300 -}}
                          {{- $responseColorBg = "bg-red1" -}}
                          {{- $responseColorTxt = "red-dark" -}}
                        {{- end -}}
                        {{- $description := .description -}}
                        {{- $hasSchema := partial "api/oas/has-schema.html" . -}}

                        {{- if $hasSchema -}}
                          {{- with .content -}}
                            {{- $multiSchema := false -}}
                            {{- if gt (len .) 1 -}}
                              {{- $multiSchema = true -}}
                            {{- end -}}
                            <details class="mb-disclosure mb-disclosure--arrow {{ $responseColorBg }} mbxs">
                              <summary class="{{ $responseColorTxt }}" aria-label="Disclose response {{ $response }} {{ $description }} details">
                                <span
                                data-mybicon="mybicon-arrow-right"
                                data-mybicon-width="16"
                                data-mybicon-height="16"
                                ></span>
                                <span class="fw600">{{ $response }}</span> {{ $description }}
                              </summary>
                              <div class="bg-gray1 pam">
                                <h4 class="fw600">Schema</h4>
                                {{- if $multiSchema -}}
                                  <label class="form__label text-basic dib" for="{{ $endpointId }}-{{ $response }}">Media type:</label>
                                  <select id="{{$endpointId}}-{{$response}}" data-sub-of="{{ $endpointId }}-{{ $response }}" class="form__control wauto maxw100p paxs dib hauto" name="formats">
                                    {{- range $applicationType, $_ := . -}}
                                      {{- $typeClean := lower (anchorize $applicationType) -}}
                                      <option value="{{ $typeClean }}">
                                        {{ $applicationType }}
                                      </option>
                                    {{- end -}}
                                  </select>
                                {{- else -}}
                                  {{- range $applicationType, $_ := . -}}
                                    <p>Media type: {{ $applicationType }}</p>
                                  {{- end -}}
                                {{- end -}}

                                {{- range $application, $_ := . -}}
                                  {{- $fTC := partial "api/oas/format-type-clean.html" (dict "application" $application) -}}
                                  {{- $format := $fTC.format -}}
                                  {{- $typeClean := $fTC.typeClean -}}

                                  <dl class="schema-type-container desc-list pam bshadow bg-white" data-type="{{ $typeClean }}">
                                    {{- if eq "xml" $format -}}
                                      {{- partial "api/oas/response-schema-xml.html" (dict "schemaObj" .schema "name" "" "components" $components "responseCode" $response "endpointId" $endpointId "recLevel" 0) -}}
                                    {{- else -}}
                                      {{- partial "api/oas/response-schema.html" (dict "schemaObj" .schema "name" "" "components" $components "responseCode" $response "endpointId" $endpointId "recLevel" 0) -}}
                                    {{- end -}}
                                  </dl>
                                {{- end -}}
                              </div>
                            </details>
                          {{- end -}}
                        {{- else -}}
                          <div class="{{ $responseColorBg }} {{ $responseColorTxt }} response mbxs"><span class="fw600">{{ $response }}</span> {{ $description }}</div>
                        {{- end -}}
                      {{- end -}}
                    {{- end -}}
                  </div>
                  <div class="example-area">
                    {{- with .requestBody.content -}}
                      {{- partial "api/oas/requestexample.html" (dict "ctx" . "endpointId" $endpointId "components" $components) -}}
                    {{- end -}}
                    {{ with .responses }}
                      {{- partial "api/oas/responseexample.html" (dict "ctx" . "endpointId" $endpointId "components" $components) -}}
                    {{- end -}}
                  </div>
                </div>
                {{- end -}}
            {{- end -}}
          {{- end -}}
        </section>
        {{- if and (eq (getenv "HUGO_ENV") "production") (isset $.Params "disqus_identifier") -}}
          <section id="api-support" class="dev-docscontent__section maxw64r">
            {{- template "_internal/disqus.html" $ -}}
          </section>
        {{- end -}}
      </article>
    </main>
  {{- else -}}
    {{- partial "api/docs.html" . -}}
  {{- end -}}
{{- end -}}
