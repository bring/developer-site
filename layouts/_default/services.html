{{- define "main" -}}
{{- $maxwidth := "maxw80r" -}}
{{- if (eq ($.Param "widelayout") true) -}}
  {{- $maxwidth = "" -}}
{{- end -}}

<div class="dev-docs__menu" data-drawer data-drawer-event>
  {{- partial "sidemenu.html" . -}}
</div>
{{- partial "drawmenu.html" . -}}
<div class="dev-docs__page">
  <main id="main" class="dev-docscontent w100p {{ $maxwidth }}">
    <article>
      <h1>
        {{- .Title -}}
        {{- with .Params.titlesub -}}
          <span class="db text-title mts">{{ . }}</span>
        {{- end -}}
      </h1>
      <section class="dev-docscontent__section">
        {{- .Content -}}
        <div class="flex flex-wrap align-ic mbl">
          <h2 class="mrl">Shipping Guide and Booking APIs</h2>
          <a href="#" class="btn-link--dark">Download spreadsheet</a>
        </div>
        <div class="flex flex-wrap align-ifs mbs">
          <div class="bg-gray2 pal pbm rad-a2px">
            <div class="flex flex-wrap align-ifs">
              <div class="mrl">
                <p class="form__label">Filter by</p>
                <div class="btngroup">
                  <button class="btn btn--white" data-filterbtn="type">Service type</button>
                  <button class="btn btn--white" data-filterbtn="family">Service family</button>
                  <button class="btn btn--white" data-filterbtn="cntype">Customer number type</button>
                </div>
                <div id="filtersets">

                  {{- $.Scratch.Add "type" slice -}}
                  {{- $.Scratch.Add "family" slice -}}
                  {{- $.Scratch.Add "cnType" slice -}}
                  {{- range .Site.Data.services -}}
                    {{- $.Scratch.Add "type" .Type }}
                    {{- $.Scratch.Add "family" .ServiceFamily }}
                    {{- $.Scratch.Add "cnType" .CustomerNumberType }}
                  {{- end -}}

                  {{- partial "api/servicefilter.html" (dict "scratcher" ($.Scratch.Get "type") "filter" "type" ) -}}
                  {{- partial "api/servicefilter.html" (dict "scratcher" ($.Scratch.Get "family") "filter" "family" ) -}}
                  {{- partial "api/servicefilter.html" (dict "scratcher" ($.Scratch.Get "cnType") "filter" "cntype" ) -}}

                </div>
            </div>
              <label class="form__label mrxl" for="servicefilter">
              Service name, service code or request code
              <input id="servicefilter" type="text" class="form__control mrxs w100p maxw32r"/>
              </label>
              <button class="btn-link--dark" id="clearfilters">Clear filters</button>
            </div>

          </div>
        </div>
        <table id="servicetable">
          <thead>
            <tr>
              <th rowspan="2">Service</th>
              <th rowspan="2">Customer number type</th>
              <th colspan="2">Codes</th>
              <th rowspan="2">Return</th>
              <th rowspan="2">APIs</th>
              <th rowspan="2">Required setup</th>
              <th rowspan="2">Prices</th>
              <th rowspan="2">Lead time</th>
              <th colspan="3">Countries</th>
            </tr>
            <tr>
              <th>Service</th>
              <th>Request</th>
              <th>Sender</th>
              <th>Destination</th>
              <th>Domestic</th>
            </tr>
          </thead>
          <tbody>
          {{- range .Site.Data.services -}}
            <tr>
              <th scope="row" class="lh-tight">
                <span data-filter="name">{{ .ServiceName }}</span><br>
                <span class="text-note">{{ if ne .Type "-" }}Type: <span class="fwn" data-filter="type">{{ .Type }}</span><br>{{ end }}
                {{ if ne .serviceFamily "-" }}Family: <span class="fwn" data-filter="family">{{ .ServiceFamily }}</span>{{ end }}
              </th>
              <td data-filer="cntype">{{ .CustomerNumberType }}</span></td>
              <td data-filter="servcode">{{ .ServiceCode }}</td>
              <td class="ofw-anywhere"><code data-filter="reqcode">{{ .RequestCode }}</code></td>
              <td class="mb-table__cell--icon tc">{{ if eq .Return "Yes" }}<span
                data-mybicon="mybicon-check"
                data-mybicon-class="icon-ui--green-dark mrs"
                data-mybicon-width="16"
                data-mybicon-height="16"
                data-mybicon-title="Yes"
              ></span>{{else}}
              <span
                data-mybicon="mybicon-cross"
                data-mybicon-class="icon-ui--lightgray mrs"
                data-mybicon-width="16"
                data-mybicon-height="16"
                data-mybicon-title="No"
              ></span>
              {{ end }}</td>
              <td>
                {{if eq .Booking "Yes"}}<span class="mb-badge mrs">Booking</span><br>{{ end }}
                {{ if eq .ShippingGuide "Yes" }}<span class="mb-badge ws-nowrap">Shipping Guide</span>{{ end }}
              </td>
              <td>{{ if and (ne .RequiredSetup "-") (ne .RequiredSetup "") }}{{ .RequiredSetup }}{{ end }}</td>
              <td>
                {{ if eq .ListPrice "Yes" }}<span class="mb-badge mrs">List</span><br>{{end}}
                {{ if eq .AgreementPrice "Yes" }}<span class="mb-badge">Agreement</span>{{end}}
              </td>
              <td class="mb-table__cell--icon tc">{{ if eq .LeadTime "Yes" }}<span
                data-mybicon="mybicon-check"
                data-mybicon-class="icon-ui--green-dark mrs"
                data-mybicon-width="16"
                data-mybicon-height="16"
                data-mybicon-title="Yes"
              ></span>{{else}}
              <span
                data-mybicon="mybicon-cross"
                data-mybicon-class="icon-ui--lightgray mrs"
                data-mybicon-width="16"
                data-mybicon-height="16"
                data-mybicon-title="No"
              ></span>
              {{ end }}</td>
              <td class="maxw16r">{{ if ne .SenderCountries "-" }}{{ .SenderCountries }}{{ end }}</td>
              <td class="maxw16r">{{ if ne .Destination "-" }}{{ .Destination }}{{ end }}</td>
              <td class="maxw16r">{{ if ne .DomesticAllowed "-" }}{{ .DomesticAllowed }}{{ end }}</td>
              {{- end -}}
            </tr>
          </tbody>
        </table>
        <button class="btn btn--white mbxl">Show all services</button>
        <script>
          const rows = document.querySelectorAll('#servicetable tbody tr')
          const filterInput = document.querySelector('#servicefilter')
          const filterBtns = document.querySelectorAll('[data-filterbtn]')
          const filterSets = document.querySelectorAll('#filtersets fieldset')
          const filterChecks = document.querySelectorAll('[data-check]')
          const clearBtn = document.querySelector('#clearfilters')

          function clearFilters() {
            const activeBtn = document.querySelector('[data-filterbtn].active')
            if (activeBtn) {
              activeBtn.classList.remove('active')
            }
            filterSets.forEach((set) => {
              set.hidden = true
              set.classList.remove('flex')
            })
            filterChecks.forEach((filterCheck) => {
              filterCheck.checked = false
            })
            rows.forEach((row) => {
              row.hidden = false
            })
            filterInput.disabled = false
            filterInput.value = ""
          }

          clearBtn.addEventListener('click', function() {
            clearFilters()
          })

          filterInput.addEventListener('keyup', function(e) {
            const query = event.target.value.toLowerCase()
            rows.forEach((row) => {
              if (
                row.querySelector('[data-filter="name"]').textContent.toLowerCase().includes(query) 
                || row.querySelector('[data-filter="servcode"]').textContent.toLowerCase().includes(query) 
                || row.querySelector('[data-filter="reqcode"]').textContent.toLowerCase().includes(query)
              ) {
                row.hidden = false
              } else {
                row.hidden = true
              }
            })
          })

          filterBtns.forEach((filterBtn) => {
            filterBtn.addEventListener('click', function(e){
              const filterType = e.target.dataset.filterbtn

              if (e.target.classList.contains('active')) {
                clearFilters()
                return
              }

              clearFilters()
              e.target.classList.add('active')
              filterInput.disabled = true

              filterSets.forEach((set) => {
                if (set.id === filterType) {
                  if (set.hidden === false) {
                    set.hidden = true
                    set.classList.remove('flex')
                  } else {
                    set.hidden = false
                    set.classList.add('flex')
                  }
                } else {
                    set.hidden = true
                    set.classList.remove('flex')
                }
              })
            })
          })

          // when a check is clicked
          // take all the checked within the fieldset and show all that matches
          // hide everything else
          // unless nothing is checked, then show everything

          filterChecks.forEach((filterCheck) => {
            filterCheck.addEventListener('click', function(e) {
              const query = e.target.value.toLowerCase()
              const filterType = e.target.dataset.filter
              const dataFilter = '[data-filter="' + filterType + '"]'

              rows.forEach((row) => {
                if (row.querySelector(dataFilter).textContent.toLowerCase().includes(query)) {
                  if (e.target.checked === true) {
                    row.hidden = false
                  } else {
                    row.hidden = true
                  }
                } else {
                  row.hidden = true
                }
              })

              // rows.forEach((row) => {
              //   if (row.querySelector(dataFilter).textContent.toLowerCase().includes(query)) {
              //     row.hidden = false
              //   } else {
              //     row.hidden = true
              //   }
              // })
            })
          })
        </script>
      </section>
    </article>
  </main>
  {{ partial "footer.html" . }}
  <div class="dev-obfuscator" data-drawer data-drawer-event></div>
</div>
{{- end -}}
